<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiftMetrics</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
        }

        #app {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 20px;
        }

        #search-container {
            margin-bottom: 20px;
        }

        #search-input {
            width: 300px;
            padding: 5px;
        }

        #search-results {
            list-style-type: none;
            padding: 0;
            margin: 10px 0;
        }

        #search-results li {
            cursor: pointer;
            padding: 5px;
        }

        #search-results li:hover {
            background-color: #f0f0f0;
        }

        #table-container {
            max-width: 100%;
            overflow-x: auto;
            margin-top: 20px;
        }

        #lifter-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        #lifter-table th,
        #lifter-table td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: left;
        }

        #lifter-table th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        #lifter-table tbody {
            max-height: 400px;
            overflow-y: auto;
        }

        #errorMessage {
            color: red;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div id="app">
        <h1>LiftMetrics</h1>

        <div id="search-container">
            <label for="search-input">Search lifters:</label>
            <input type="text" id="search-input" placeholder="Enter lifter name">
        </div>

        <div id="errorMessage"></div>

        <div id="table-container">
            <table id="lifter-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Meet Name</th>
                        <th>Squat Attempts</th>
                        <th>Bench Attempts</th>
                        <th>Deadlift Attempts</th>
                        <th>Total Attempts</th>
                        <th>Squat 1%</th>
                        <th>Squat 2%</th>
                        <th>Squat 3%</th>
                        <th>Bench 1%</th>
                        <th>Bench 2%</th>
                        <th>Bench 3%</th>
                        <th>Deadlift 1%</th>
                        <th>Deadlift 2%</th>
                        <th>Deadlift 3%</th>
                        <th>Squat 1-2 (kg)</th>
                        <th>Squat 2-3 (kg)</th>
                        <th>Bench 1-2 (kg)</th>
                        <th>Bench 2-3 (kg)</th>
                        <th>Deadlift 1-2 (kg)</th>
                        <th>Deadlift 2-3 (kg)</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Table rows will be dynamically inserted here -->
                </tbody>
            </table>
        </div>
    </div>

<script>

    // DOM elements
    let searchInput;
    let lifterTable;
    let errorMessage;
    let searchResults;

    // Wait for the DOM to be fully loaded before accessing elements
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize variables after the DOM is loaded
        searchInput = document.getElementById('search-input');
        lifterTable = document.getElementById('lifter-table');
        errorMessage = document.getElementById('errorMessage');
        searchResults = document.getElementById('search-results');

        // If search-results doesn't exist, create and append it
        if (!searchResults) {
            searchResults = document.createElement('ul');
            searchResults.id = 'search-results';
            document.getElementById('search-container').appendChild(searchResults);
        }

        // Add event listener to the search input
        searchInput.addEventListener('input', debounce(searchLifters, 300));
    });

    /**
     * Debounce function to limit the rate at which a function can fire.
     * @param {Function} func - The function to debounce.
     * @param {number} delay - The number of milliseconds to delay.
     * @return {Function} A debounced version of the passed function.
     */
    function debounce(func, delay) {
        let debounceTimer;
        return function() {
            const context = this;
            const args = arguments;
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => func.apply(context, args), delay);
        }
    }

    /**
     * Search for lifters based on the input value.
     */
    function searchLifters() {
        const query = searchInput.value.trim();
        if (query.length === 0) {
            clearTable();
            searchResults.innerHTML = '';
            return;
        }

        fetch(`/api/search?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(lifters => {
                searchResults.innerHTML = '';
                if (lifters.length > 0) {
                    lifters.forEach(lifter => {
                        const li = document.createElement('li');
                        li.textContent = lifter;
                        li.addEventListener('click', () => displayLifterDetails(lifter));
                        searchResults.appendChild(li);
                    });
                } else {
                    errorMessage.textContent = 'No lifters found.';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                errorMessage.textContent = 'An error occurred while searching.';
            });
    }
        /**
     * @typedef {Object} LifterDetail
     * @property {string} date
     * @property {string} meetName
     * @property {number} successfulSquatAttempts
     * @property {number} successfulBenchAttempts
     * @property {number} successfulDeadliftAttempts
     * @property {number} totalSuccessfulAttempts
     * @property {number} squat1Perc
     * @property {number} squat2Perc
     * @property {number} squat3Perc
     * @property {number} bench1Perc
     * @property {number} bench2Perc
     * @property {number} bench3Perc
     * @property {number} deadlift1Perc
     * @property {number} deadlift2Perc
     * @property {number} deadlift3Perc
     * @property {number} squat1To2Kg
     * @property {number} squat2To3Kg
     * @property {number} bench1To2Kg
     * @property {number} bench2To3Kg
     * @property {number} deadlift1To2Kg
     * @property {number} deadlift2To3Kg
     */
    /**
     * Display details for a specific lifter.
     * @param {string} lifterName - The name of the lifter to display details for.
     */
    function displayLifterDetails(lifterName) {
        fetch(`/api/lifter-details?name=${encodeURIComponent(lifterName)}`)
            .then(response => response.json())
            .then(details => {
                clearTable();
                const tbody = lifterTable.querySelector('tbody');
                details.forEach(detail => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${detail.date}</td>
                        <td>${detail.meetName}</td>
                        <td>${detail.successfulSquatAttempts}</td>
                        <td>${detail.successfulBenchAttempts}</td>
                        <td>${detail.successfulDeadliftAttempts}</td>
                        <td>${detail.totalSuccessfulAttempts}</td>
                        <td>${detail.squat1Perc.toFixed(2)}</td>
                        <td>${detail.squat2Perc.toFixed(2)}</td>
                        <td>${detail.squat3Perc.toFixed(2)}</td>
                        <td>${detail.bench1Perc.toFixed(2)}</td>
                        <td>${detail.bench2Perc.toFixed(2)}</td>
                        <td>${detail.bench3Perc.toFixed(2)}</td>
                        <td>${detail.deadlift1Perc.toFixed(2)}</td>
                        <td>${detail.deadlift2Perc.toFixed(2)}</td>
                        <td>${detail.deadlift3Perc.toFixed(2)}</td>
                        <td>${detail.squat1To2Kg.toFixed(2)}</td>
                        <td>${detail.squat2To3Kg.toFixed(2)}</td>
                        <td>${detail.bench1To2Kg.toFixed(2)}</td>
                        <td>${detail.bench2To3Kg.toFixed(2)}</td>
                        <td>${detail.deadlift1To2Kg.toFixed(2)}</td>
                        <td>${detail.deadlift2To3Kg.toFixed(2)}</td>
                    `;
                });
                searchResults.innerHTML = '';
            })
            .catch(error => {
                console.error('Error:', error);
                errorMessage.textContent = 'An error occurred while fetching lifter details.';
            });
    }

    /**
     * Clear the table and error message.
     */
    function clearTable() {
        const tbody = lifterTable.querySelector('tbody');
        tbody.innerHTML = '';
        errorMessage.textContent = '';
    }
</script>
</body>
</html>